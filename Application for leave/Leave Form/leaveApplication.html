<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application for Leave</title>
    <link rel="stylesheet" href="leaveApplication.css">
    <script src="fetch_offices.php"></script>

    <!-- Datepicker CSS -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
        rel="stylesheet" />
</head>

<body>
    <div id="header"></div>
    <script>
        fetch("header.html")
            .then(response => response.text())
            .then(data => document.getElementById("header").innerHTML = data);
    </script>

    <div class="wrapper">
        <form action="submit_leave.php" method="post">
            <div id="personalDetails"></div>
            <table class="container-table">
                <tr>
                    <td colspan="2" class="title">
                        <h5>6. DETAILS OF APPLICATION</h5>
                    </td>
                </tr>
                <tr>
                    <td class="divider">
                        <div id="sectionA"></div>
                    </td>
                    <td class="divider">
                        <div id="sectionB"></div>
                    </td>
                </tr>
                <tr>
                    <td class="divider">
                        <div id="sectionC">
                            <div class="container" style="margin-top: 50px;">
                                <label>6.C NUMBER OF WORKING DAYS APPLIED FOR</label>
                                <input type="text" id="workingDays" class="form-control" readonly />

                                <label>Inclusive Dates</label>
                                <div class="input-group date" id="datepicker">
                                    <input type="text" class="form-control" id="Dates" name="inclDates" placeholder="Select days" required readonly />
                                    <span class="input-group-addon">
                                        <i class="glyphicon glyphicon-calendar"></i>
                                    </span>
                                </div>
                            </div>

                        </div>
                    </td>
                    <td class="divider">
                        <div id="sectionD"></div>
                    </td>
                </tr>
            </table>
            <div id="actionDetails"></div>

                <div class="buttonGroup">
        <input type="submit" value="Submit">
    </div>
        </form>
    </div>

    <!-- Your custom scripts -->
    <script src="../Leave Form/details/loadSections.js"></script>
    <script src="dropdown.js"></script>

    <!-- Required JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    function loadSection(id, url) {
        fetch(url)
            .then(response => response.text())
            .then(data => {
                document.getElementById(id).innerHTML = data;

                if (id === "sectionC") {
                    const $datepicker = $('#datepicker');
                    let selectedDates = [];

                    $datepicker.datepicker({
                        startDate: new Date(),
                        multidate: true,
                        format: "mm/dd/yyyy", // We'll override the display anyway
                        daysOfWeekHighlighted: [5, 6],
                        todayHighlight: true,
                        autoclose: false
                    }).on('changeDate', function (e) {
                        selectedDates = e.dates
                            .map(date => new Date(date))
                            .sort((a, b) => a - b);

                        setTimeout(() => {
                            $('#Dates').val(formatDateRanges(selectedDates));
                            $('#workingDays').val(selectedDates.length);
                        }, 0);
                    });

                    // Reapply formatted text when calendar hides (clicked outside)
                    $datepicker.on('hide', function () {
                        setTimeout(() => {
                            $('#Dates').val(formatDateRanges(selectedDates));
                        }, 0);
                    });

                    // Show calendar when calendar icon is clicked
                    $('.input-group-addon').click(function () {
                        $datepicker.datepicker('show');
                    });
                }
            })
            .catch(error => console.error(`Error loading ${url}:`, error));
    }

    loadSection("sectionC", "details/sections/SectionC_Dates.html");

    // Formatting helpers
    function formatDate(date) {
        return date.toLocaleDateString('en-US', {
            month: 'long',
            day: 'numeric',
            year: 'numeric'
        });
    }

    function isConsecutive(date1, date2) {
        return date2.getTime() - date1.getTime() === 86400000;
    }

    function makeRange(start, end) {
        const sameDay = start.getTime() === end.getTime();
        if (sameDay) {
            return formatDate(start);
        }

        const sameMonthYear = start.getFullYear() === end.getFullYear() &&
                              start.getMonth() === end.getMonth();

        if (sameMonthYear) {
            return `${start.toLocaleDateString('en-US', { month: 'long' })} ${start.getDate()}–${end.getDate()}, ${start.getFullYear()}`;
        } else {
            return `${formatDate(start)}–${formatDate(end)}`;
        }
    }

    function formatDateRanges(dates) {
        if (!dates.length) return '';

        const ranges = [];
        let start = dates[0];
        let end = start;

        for (let i = 1; i < dates.length; i++) {
            if (isConsecutive(end, dates[i])) {
                end = dates[i];
            } else {
                ranges.push(makeRange(start, end));
                start = dates[i];
                end = start;
            }
        }
        ranges.push(makeRange(start, end));
        return ranges.join(', ');
    }
});
</script>

</body>

</html>